var ui;!function(a){function b(a,b){conversations.refresh(function(){b.iscrollview.refresh()})}function c(a,b){conversations.refresh(function(){b.iscrollview.refresh()})}function d(){h.initialize(),j.initialize(),k.initialize(),l.initialize(),e.initialize(),f.initialize(),i.initialize()}a.onPullDown=b,a.onPullUp=c,a.initialize=d;var e;!function(a){function b(){$("body").on("pagecontainerchange",function(a,b){"page-conversation"===b.toPage.attr("id")&&($.mobile.silentScroll(b.toPage.height()),$("#conversation-message-input").val(""))}),$("#conversation-send-message-button").on("click",function(){var a=$("#conversation-message-input");a.val().length>160?ui.notifications.showToastNotification("Message exceeds 160 characters."):""===a.val()?ui.notifications.showToastNotification("Message is empty."):(ui.loading.startLoading(),api.sendSms(settings.getUsername(),settings.getPassword(),settings.getLocalPhoneNumber(),conversations.getActiveConversationPhoneNumber(),a.val(),function(a,b){a?conversations.refresh(function(){for(var a=conversations.get(),b=0;b<a.length;b++)if(a[b].getRemotePhoneNumber()===conversations.getActiveConversationPhoneNumber()){c(a[b],function(){ui.loading.stopLoading()});break}}):(ui.notifications.showToastNotification(b),ui.loading.stopLoading())}))})}function c(a,b){void 0===b&&(b=null),ui.loading.startLoading();var c=$("#page-conversation-header"),d=$("#conversation-listview");c.empty(),d.empty(),contacts.getContact(null,a.messages[0].getRemotePhoneNumber(),function(e){c.append(null!==e&&null!==e.displayName?e.displayName:a.messages[0].getRemotePhoneNumber());for(var f=0;f<a.messages.length;f++){var g=$("<li>");1===a.messages[f].type?g.append($("<span>You</span>")):0===a.messages[f].type&&g.append(null!==e&&null!==e.displayName?$("<span>"+e.displayName+"</span>"):$("<span>"+a.messages[f].getRemotePhoneNumber()+"</span>"));var h;h=moment(a.messages[f].date).format(moment(a.messages[f].date).isSame(moment(),"day")?"h:mm A":moment(a.messages[f].date).isSame(moment(),"year")?"MMM D":"YY/MM/DD"),g.append($('<p class="ui-li-aside date-time-container"><span class="date-time">'+h+"</span></p>")),g.append($("<br>")),g.append($('<p class="message-text">'+a.messages[f].text+"</p>")),d.append(g)}d.listview("refresh"),ui.loading.stopLoading(),$.mobile.silentScroll($("#page-conversation").height()),$("#conversation-message-input").val(""),null!==b&&b()})}a.initialize=b,a.display=c}(e=a.conversationpage||(a.conversationpage={}));var f;!function(a){function b(){$("body").on("pagecontainerchange",function(a,b){"conversations-page"===b.toPage.attr("id")&&(d(),$.mobile.silentScroll(0))})}function c(a){for(var b=conversations.get(),c=null,d=null,e=0;e<b.length;e++)if(b[e].getRemotePhoneNumber()===a){c=b[e],d=e;break}if(null!==c){conversations.setActiveConversationPhoneNumber(c.getRemotePhoneNumber()),c.markAllMessagesAsRead(),b[d]=c,conversations.set(b);var f=$("#page-conversation");$("body").pagecontainer("change",f),ui.conversationpage.display(c)}}function d(a){void 0===a&&(a=null),ui.loading.startLoading(),$("#conversations-listview").css("display","none"),conversations.refresh(function(b){function d(){$("#conversations-listview").css("display",""),ui.loading.stopLoading(),$.mobile.silentScroll(0),$('a[data-item-type="conversations-listview-item"]').on("click",function(){c($(this).attr("data-phone-number"))}),ui.notifications.notificationClicked&&ui.notifications.processNotificationClick(),null!==a&&a()}var e=conversations.get();if(null!==e){$("#conversations-listview").empty();var f=0;async.eachSeries(e,function(a,b){contacts.getContact(null,a.getRemotePhoneNumber(),function(c){function d(){h.append(null!==c&&null!=c.displayName?"<h2>"+c.displayName+"</h2>":"<h2>"+a.getRemotePhoneNumber()+"</h2>"),h.append(1===a.messages[a.messages.length-1].type?'<p class="back-icon-container"><a href="#" class="back-icon-link ui-btn ui-btn-d ui-nodisc-icon ui-btn-corner-all ui-icon-back ui-btn-icon-notext ui-alt-icon"></a><span class="message-preview-text">'+a.messages[a.messages.length-1].text+"</span></p>":"<p>"+a.messages[a.messages.length-1].text+"</p>");var d=e[e.length-1].date,i=$('<p class="ui-li-aside date-time-container">'),j=$('<span class="date-time">');j.append(d.isSame(moment().utc(),"day")?d.local().format("h:mm A"):d.isSame(moment().utc(),"year")?d.local().format("MMM D"):moment(d).local().format("YY/MM/DD")),i.append(j),h.append(i);for(var k=0,l=0;l<e.length;l++)e[l].unread&&k++;k>0&&h.append('<p class="ui-li-count unread-count">'+k+"</p>"),$("#conversations-listview").append(g),f+=1,b()}var e=a.messages,g=$("<li>"),h=$('<a id="conversations-listview-item-'+f+'" data-item-type="conversations-listview-item" data-phone-number="'+a.getRemotePhoneNumber()+'" href="#">');g.append(h),null!==c&&null!==c.photos&&c.photos.length>0?$.get(c.photos[0].value,function(){h.append('<img class="thumbnail" src="'+c.photos[0].value+'">'),d()}).fail(function(){h.append('<img src="images/placeholder.png">'),d()}):(h.append('<img src="images/placeholder.png">'),d())})},function(){$("#conversations-listview").listview("refresh"),d()})}else d();null!==b&&ui.notifications.showToastNotification(b)})}a.initialize=b,a.showConversation=c,a.display=d}(f=a.conversationspage||(a.conversationspage={}));var g;!function(a){function b(){return e}function c(){e||($("body").pagecontainer("getActivePage").addClass("ui-disabled"),$.mobile.loading("show",{textVisible:!0}),e=!0)}function d(){e&&($("body").pagecontainer("getActivePage").removeClass("ui-disabled"),$.mobile.loading("hide"),e=!1)}var e=!1;a.isLoading=b,a.startLoading=c,a.stopLoading=d}(g=a.loading||(a.loading={}));var h;!function(a){function b(){$(document).on("menubutton",function(){ui.loading.isLoading()||"conversations-page"===$("body").pagecontainer("getActivePage").attr("id")&&$("#menu").panel("toggle")}),$(".menu-button").on("click",function(){$("#menu").panel("toggle")}),$("#menu-refresh-button").on("click",function(){ui.conversationspage.display()}),$("#menu-mark-all-read-button").on("click",function(){conversations.markAllAsRead(),ui.conversationspage.display()})}a.initialize=b}(h=a.menu||(a.menu={}));var i;!function(a){function b(){$(document).on("backbutton",function(){ui.loading.isLoading()||history.back()}),$(".button-back").on("click",function(){history.back()}),$(".external-link").on("click",function(){var a=$(this).attr("data-link");window.open(a,"_system")})}a.initialize=b}(i=a.main||(a.main={}));var j;!function(a){function b(){$("body").on("pagecontainerchange",function(a,b){"new-conversation-page"===b.toPage.attr("id")&&($("#new-conversation-recipient-input").val(""),$("#new-conversation-message-textarea").val(""))}),$("#new-conversation-contacts-button").on("click",function(){window.plugins.ContactChooser.chooseContact(function(a){if(""===a.phoneNumber)ui.notifications.showToastNotification("Selected contact does not have a phone number.");else{var b=a.phoneNumber;b=b.replace(/[^\d]/g,""),b=b.replace(/^.*(\d{10})$/,"$1"),$("#new-conversation-recipient-input").val(b)}})}),$("#new-conversation-send-button").on("click",function(){var a=$("#new-conversation-message-textarea"),b=$("#new-conversation-recipient-input").val().replace(/[^\d]/g,"").replace(/^.*(\d{10})$/,"$1");10!==b.length?ui.notifications.showToastNotification("Phone number is not valid."):a.val().length>160?ui.notifications.showToastNotification("Message exceeds 160 characters."):""===a.val()?ui.notifications.showToastNotification("Message is empty."):(ui.loading.startLoading(),api.sendSms(settings.getUsername(),settings.getPassword(),settings.getLocalPhoneNumber(),b,a.val(),function(a,b){a?history.back():ui.notifications.showToastNotification(b),ui.loading.stopLoading()}))})}a.initialize=b}(j=a.newconversationpage||(a.newconversationpage={}));var k;!function(a){function b(){window.plugin.notification.local.oncancel=function(b,c,d){a.notificationClicked=!0,g=JSON.parse(d),"conversations-page"!==$("body").pagecontainer("getActivePage").attr("id")?history.back():ui.conversationspage.display()}}function c(){ui.conversationspage.showConversation(g),a.notificationClicked=!1}function d(a,b,c){void 0===b&&(b="error"),void 0===c&&(c="bottom");var d=noty({text:a,type:b,layout:c});d.show()}function e(a,b,c,d,e){window.plugin.notification.local.add({id:String(a),title:b,message:c,badge:d,json:e,autoCancel:!0})}function f(a){window.plugin.notification.local.cancel(a)}a.notificationClicked=!1;var g=null;a.initialize=b,a.processNotificationClick=c,a.showToastNotification=d,a.showStatusBarNotification=e,a.hideStatusBarNotification=f}(k=a.notifications||(a.notifications={}));var l;!function(a){function b(){$("body").on("pagecontainerchange",function(a,b){"page-settings"===b.toPage.attr("id")&&($("#settings-username-input").val(settings.getUsername()),$("#settings-password-input").val(settings.getPassword()),$("#settings-phone-number-input").val(settings.getLocalPhoneNumber()),$("#settings-history-input").val(String(settings.getMessagesHistory())),$("#settings-poll-rate-input").val(String(settings.getPollRate())))}),$("#settings-phone-numbers-button").on("click",function(){var a=$("#settings-phone-numbers-fieldset");ui.loading.startLoading(),api.getLocalPhoneNumbers(settings.getUsername(),settings.getPassword(),function(b,c){if(null===c)if(0===b.length)ui.notifications.showToastNotification("No phone numbers available. Is SMS enabled on the phone number you wish to use?");else{a.empty();for(var d=0;d<b.length;d++)a.append($('<input id="settings-phone-numbers-radio-button-'+d+'" name="'+b[d]+'" type="radio">')),a.append($('<label for="settings-phone-numbers-radio-button-'+d+'">'+b[d]+"</label>"));a.children().first().prop("checked",!0),$("#settings-phone-numbers-form").trigger("create"),ui.loading.stopLoading(),$("body").pagecontainer("change","#page-settings-phone-numbers")}else ui.loading.stopLoading(),ui.notifications.showToastNotification(c)})}),$("#settings-phone-numbers-select-button").on("click",function(){settings.setLocalPhoneNumber($("input:checked","#settings-phone-numbers-fieldset").attr("name")),history.back()}),$("#settings-save-button").on("click",function(){var a=$("#settings-history-input"),b=$("#settings-poll-rate-input");isNaN(a.val())||parseInt(a.val())<=0||a.val()>90?ui.notifications.showToastNotification("Number of days of SMS history to retrieve must be an integer greater than 0 and less than or equal to 90."):isNaN(b.val())||parseInt(b.val())<0?ui.notifications.showToastNotification("SMS poll rate must be an integer greater than or equal to 0."):(ui.notifications.showToastNotification("Settings saved.","success"),settings.setUsername($("#settings-username-input").val()),settings.setPassword($("#settings-password-input").val()),settings.setMessagesHistory(a.val()),settings.setPollRate(b.val()))})}a.initialize=b}(l=a.settingspage||(a.settingspage={}))}(ui||(ui={}));